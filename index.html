<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WikiRead</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    animation: {
                        'flip': 'flip 0.6s preserve-3d',
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* 3D Flip Effects */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300 text-slate-800 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Logo: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    <path d="M12 7v1"/>
                    <path d="M16 8h2"/>
                    <path d="M6 8h2"/>
                </svg>
            ),
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Magic: ({ loading }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={loading ? "animate-spin" : ""}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Translate: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 8 5-5 5 5"/><path d="M12 21a9 9 0 0 0 9-9 9 9 0 0 0-9-9 9 9 0 0 0-9 9 9 9 0 0 0 9 9"/><path d="M12 3v18"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Archive: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-1 1-1h6c1 0 1 1 1 1v2"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Bell: ({ active }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill={active ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Cards: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 14h.01"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M10 18h.01"/><path d="M14 14h.01"/><path d="M14 18h.01"/><path d="M18 14h.01"/><path d="M18 18h.01"/><rect x="3" y="10" width="18" height="11" rx="2"/><path d="M21 6V4a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2"/></svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Rotate: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
            ListChecks: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 12h10"/><path d="M11 18h10"/><path d="M11 6h10"/><path d="M3 12h.01"/><path d="M3 18h.01"/><path d="M3 6h.01"/></svg>,
            CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        };

        // --- THEME & CONFIGURATION ---
        const THEMES = {
            en: {
                activeBg: 'bg-indigo-600', activeText: 'text-indigo-600',
                btnBg: 'bg-indigo-600', btnHover: 'hover:bg-indigo-700',
                lightBg: 'bg-indigo-50', border: 'border-indigo-200',
                text: 'text-indigo-600', darkText: 'text-indigo-400',
                borderActive: 'border-indigo-500'
            },
            fr: {
                activeBg: 'bg-blue-600', activeText: 'text-blue-600',
                btnBg: 'bg-blue-600', btnHover: 'hover:bg-blue-700',
                lightBg: 'bg-blue-50', border: 'border-blue-200',
                text: 'text-blue-600', darkText: 'text-blue-400',
                borderActive: 'border-blue-500'
            },
            it: {
                activeBg: 'bg-emerald-600', activeText: 'text-emerald-600',
                btnBg: 'bg-emerald-600', btnHover: 'hover:bg-emerald-700',
                lightBg: 'bg-emerald-50', border: 'border-emerald-200',
                text: 'text-emerald-600', darkText: 'text-emerald-400',
                borderActive: 'border-emerald-500'
            },
            de: {
                activeBg: 'bg-orange-600', activeText: 'text-orange-600',
                btnBg: 'bg-orange-600', btnHover: 'hover:bg-orange-700',
                lightBg: 'bg-orange-50', border: 'border-orange-200',
                text: 'text-orange-600', darkText: 'text-orange-400',
                borderActive: 'border-orange-500'
            },
            es: {
                activeBg: 'bg-rose-600', activeText: 'text-rose-600',
                btnBg: 'bg-rose-600', btnHover: 'hover:bg-rose-700',
                lightBg: 'bg-rose-50', border: 'border-rose-200',
                text: 'text-rose-600', darkText: 'text-rose-400',
                borderActive: 'border-rose-500'
            }
        };

        const CONFIG = {
            en: {
                name: "English", flag: "üá¨üáß", wiki: "en.wikipedia.org",
                categories: ["Category:Fairy_tales", "Category:Short_stories", "Category:Folklore"],
                backup: { title: "The Lion and the Mouse", sections: [{id:0, text:"A Lion lay asleep in the forest, his great head resting on his paws.", isHeader:false}], source: "Aesop", type: "Story" }
            },
            fr: {
                name: "Fran√ßais", flag: "üá´üá∑", wiki: "fr.wikipedia.org",
                categories: ["Cat√©gorie:Conte", "Cat√©gorie:L√©gende", "Cat√©gorie:Nouvelle_fran√ßaise"],
                backup: { title: "Le Corbeau et le Renard", sections: [{id:0, text:"Ma√Ætre Corbeau, sur un arbre perch√©, tenait en son bec un fromage.", isHeader:false}], source: "La Fontaine", type: "Conte" }
            },
            it: {
                name: "Italiano", flag: "üáÆüáπ", wiki: "it.wikipedia.org",
                categories: ["Category:Fiabe", "Category:Favole", "Category:Novelle"],
                backup: { title: "Il Leone e il Topo", sections: [{id:0, text:"Un leone dormiva nel bosco. Un topo gli corse addosso.", isHeader:false}], source: "Esopo", type: "Favola" }
            },
            de: {
                name: "Deutsch", flag: "üá©üá™", wiki: "de.wikipedia.org",
                categories: ["Kategorie:M√§rchen", "Kategorie:Fabel", "Kategorie:Kurzgeschichte"],
                backup: { title: "H√§nsel und Gretel", sections: [{id:0, text:"Vor einem gro√üen Walde wohnte ein armer Holzhacker mit seiner Frau.", isHeader:false}], source: "Grimm", type: "M√§rchen" }
            },
            es: {
                name: "Espa√±ol", flag: "üá™üá∏", wiki: "es.wikipedia.org",
                categories: ["Categor√≠a:Cuentos", "Categor√≠a:Leyendas", "Categor√≠a:F√°bulas"],
                backup: { title: "Don Quijote (Fragmento)", sections: [{id:0, text:"En un lugar de la Mancha, de cuyo nombre no quiero acordarme...", isHeader:false}], source: "Cervantes", type: "Novela" }
            }
        };

        // --- UTILS ---
        
        const translateText = async (text, sourceLang) => {
            if (!text || text.trim().length === 0) return "";
            
            // Temizleme: √áok fazla bo≈üluk veya satƒ±r sonunu tek bo≈üluƒüa indir
            const cleanText = text.replace(/<[^>]*>?/gm, ' ').replace(/\s+/g, ' ').trim(); 

            // Eƒüer metin kƒ±sa ise (kelime se√ßimi gibi), b√∂lmeye gerek yok, direkt √ßevir.
            if (cleanText.length < 100) {
                 try {
                    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanText)}&langpair=${sourceLang}|tr`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return data.responseStatus === 200 ? data.responseData.translatedText : null;
                } catch (err) {
                    console.error("Single word translation error:", err);
                    return null;
                }
            }

            // Uzun metinler i√ßin par√ßalama mantƒ±ƒüƒ±
            const sentences = cleanText.match(/[^.!?]+[.!?]+|\s*$/g) || [cleanText];
            const chunks = [];
            let currentChunk = "";
            const MAX_CHUNK = 450; 

            for (let sentence of sentences) {
                if (!sentence.trim()) continue;
                if ((currentChunk + sentence).length > MAX_CHUNK) {
                    if (currentChunk) chunks.push(currentChunk);
                    currentChunk = sentence;
                } else {
                    currentChunk += sentence;
                }
            }
            if (currentChunk.trim()) chunks.push(currentChunk);

            try {
                const promises = chunks.map(async (chunk) => {
                    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunk.trim())}&langpair=${sourceLang}|tr`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return data.responseStatus === 200 ? data.responseData.translatedText : chunk;
                });

                const results = await Promise.all(promises);
                return results.join(" ");
            } catch (err) { 
                console.error("Translation error:", err);
                return null; 
            }
        };

        // --- FLASHCARD COMPONENT ---
        const FlashcardSession = ({ words, onClose, theme, darkMode }) => {
            const [index, setIndex] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);

            const handleNext = (known) => {
                if (known) setScore(s => s + 1);
                
                if (index < words.length - 1) {
                    setFlipped(false);
                    setTimeout(() => setIndex(i => i + 1), 200);
                } else {
                    setFinished(true);
                }
            };

            const reset = () => {
                setIndex(0);
                setFlipped(false);
                setScore(0);
                setFinished(false);
            };

            if (finished) {
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                        <div className={`w-full max-w-md p-8 rounded-2xl shadow-2xl text-center ${darkMode ? 'bg-slate-800 text-white' : 'bg-white text-slate-800'}`}>
                            <div className="text-5xl mb-4">üéâ</div>
                            <h2 className="text-2xl font-bold mb-2">√áalƒ±≈üma Tamamlandƒ±!</h2>
                            <p className="mb-6 opacity-80">Skorun: {score} / {words.length}</p>
                            <div className="flex gap-3 justify-center">
                                <button onClick={onClose} className="px-6 py-2 rounded-xl bg-slate-200 text-slate-700 font-medium hover:bg-slate-300 transition">Kapat</button>
                                <button onClick={reset} className={`px-6 py-2 rounded-xl text-white font-medium shadow-lg transition transform active:scale-95 ${theme.btnBg}`}>Tekrar</button>
                            </div>
                        </div>
                    </div>
                );
            }

            const currentWord = words[index];

            return (
                <div className="fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md animate-fade-in">
                    <div className="w-full max-w-lg mb-6 flex justify-between items-center text-white">
                        <span className="font-mono opacity-80">{index + 1} / {words.length}</span>
                        <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition"><Icons.Close /></button>
                    </div>

                    <div className="perspective-1000 w-full max-w-lg h-80 cursor-pointer group" onClick={() => setFlipped(!flipped)}>
                        <div className={`relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-2xl rounded-2xl ${flipped ? 'rotate-y-180' : ''}`}>
                            
                            {/* FRONT */}
                            <div className={`absolute w-full h-full backface-hidden rounded-2xl flex flex-col items-center justify-center p-8 border-2 ${darkMode ? 'bg-slate-800 border-slate-600' : 'bg-white border-slate-200'}`}>
                                <span className={`text-xs font-bold uppercase tracking-widest mb-4 opacity-50 ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Kelime</span>
                                <h3 className={`text-4xl font-bold mb-4 serif-font ${darkMode ? theme.darkText : theme.text}`}>{currentWord.text}</h3>
                                <div className="mt-8 text-sm opacity-50 flex items-center gap-2">
                                    <Icons.Rotate /> √áevirmek i√ßin dokun
                                </div>
                            </div>

                            {/* BACK */}
                            <div className={`absolute w-full h-full backface-hidden rotate-y-180 rounded-2xl flex flex-col items-center justify-center p-8 border-2 ${darkMode ? 'bg-slate-800 border-indigo-500' : 'bg-indigo-50 border-indigo-200'}`}>
                                <span className="text-xs font-bold uppercase tracking-widest mb-4 opacity-50 text-indigo-500">Anlamƒ±</span>
                                <div className="flex flex-col items-center justify-center gap-2">
                                    <span className="text-2xl font-medium text-slate-700 dark:text-slate-200">{currentWord.tr || "?"}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-8 flex gap-4 w-full max-w-lg">
                        <button onClick={() => handleNext(false)} className="flex-1 py-4 rounded-xl bg-red-100 text-red-600 font-bold hover:bg-red-200 transition">√áalƒ±≈ümalƒ±yƒ±m</button>
                        <button onClick={() => handleNext(true)} className="flex-1 py-4 rounded-xl bg-green-100 text-green-600 font-bold hover:bg-green-200 transition">Biliyorum</button>
                    </div>
                </div>
            );
        };

        // --- WORD BOX COMPONENT ---
        const WordBox = ({ currentLang, theme, darkMode }) => {
            const [allWords, setAllWords] = useState([]);
            const [flashcardSet, setFlashcardSet] = useState(null);
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());

            useEffect(() => {
                const updateWords = () => {
                    const saved = localStorage.getItem('polyglot_words');
                    if (saved) setAllWords(JSON.parse(saved));
                };
                updateWords();
                window.addEventListener('wordsUpdated', updateWords);
                return () => window.removeEventListener('wordsUpdated', updateWords);
            }, []);

            const deleteWord = (id) => {
                const newWords = allWords.filter(w => w.id !== id);
                setAllWords(newWords);
                localStorage.setItem('polyglot_words', JSON.stringify(newWords));
            };

            const startRandomFlashcards = () => {
                const visible = allWords.filter(w => w.lang === currentLang);
                const shuffled = [...visible].sort(() => 0.5 - Math.random());
                setFlashcardSet(shuffled.slice(0, 10));
            };

            const toggleSelect = (id) => {
                const next = new Set(selectedIds);
                if (next.has(id)) next.delete(id);
                else next.add(id);
                setSelectedIds(next);
            };

            const startSelectedFlashcards = () => {
                const selected = allWords.filter(w => selectedIds.has(w.id));
                // Karƒ±≈ütƒ±rarak √ßalƒ±≈ütƒ±r
                const shuffled = [...selected].sort(() => 0.5 - Math.random());
                setFlashcardSet(shuffled);
                setIsSelectionMode(false);
                setSelectedIds(new Set());
            };

            const selectAll = () => {
                const visible = allWords.filter(w => w.lang === currentLang);
                if (selectedIds.size === visible.length) setSelectedIds(new Set());
                else setSelectedIds(new Set(visible.map(w => w.id)));
            };

            const visibleWords = allWords.filter(w => w.lang === currentLang);

            return (
                <div className="animate-fade-in max-w-2xl mx-auto min-h-[60vh]">
                    {flashcardSet && (
                        <FlashcardSession 
                            words={flashcardSet} 
                            onClose={() => setFlashcardSet(null)} 
                            theme={theme} 
                            darkMode={darkMode} 
                        />
                    )}

                    <div className="flex flex-col gap-4 mb-6 pb-4 border-b border-slate-200 dark:border-slate-700">
                        <div className="flex justify-between items-center">
                            <h3 className={`text-xl font-bold flex items-center gap-2`}>
                                <Icons.Archive /> {CONFIG[currentLang].name} S√∂zl√ºƒü√º ({visibleWords.length})
                            </h3>
                            {visibleWords.length > 0 && !isSelectionMode && (
                                <div className="flex gap-2">
                                    <button onClick={() => setIsSelectionMode(true)} className={`px-4 py-2 rounded-lg text-sm font-bold border border-current opacity-70 hover:opacity-100 transition flex items-center gap-2 ${darkMode ? theme.darkText : theme.text}`}>
                                        <Icons.ListChecks /> Se√ß
                                    </button>
                                    <button onClick={startRandomFlashcards} className={`${theme.btnBg} text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:brightness-110 transition flex items-center gap-2`}>
                                        <Icons.Cards /> Rastgele 10
                                    </button>
                                </div>
                            )}
                        </div>

                        {isSelectionMode && (
                            <div className="flex justify-between items-center bg-slate-100 dark:bg-slate-800 p-3 rounded-xl animate-fade-in">
                                <div className="flex items-center gap-3">
                                    <button onClick={selectAll} className="text-sm font-semibold hover:underline">
                                        {selectedIds.size === visibleWords.length ? "Se√ßimi Kaldƒ±r" : "T√ºm√ºn√º Se√ß"}
                                    </button>
                                    <span className="text-sm opacity-50">|</span>
                                    <span className="text-sm font-medium">{selectedIds.size} se√ßildi</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { setIsSelectionMode(false); setSelectedIds(new Set()); }} className="px-3 py-1.5 text-sm font-medium hover:bg-black/5 dark:hover:bg-white/10 rounded-lg transition">
                                        Vazge√ß
                                    </button>
                                    <button 
                                        onClick={startSelectedFlashcards} 
                                        disabled={selectedIds.size === 0}
                                        className={`${theme.btnBg} text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:brightness-110 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2`}
                                    >
                                        <Icons.Play /> √áalƒ±≈ü ({selectedIds.size})
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {visibleWords.length === 0 ? (
                        <div className="text-center py-20 opacity-50 flex flex-col items-center">
                            <span className="text-4xl mb-2">üìù</span>
                            <p>Hen√ºz kelime yok.</p>
                        </div>
                    ) : (
                        <div className="grid gap-3">
                            {visibleWords.slice().reverse().map(w => {
                                const isSelected = selectedIds.has(w.id);
                                return (
                                    <div 
                                        key={w.id} 
                                        onClick={() => isSelectionMode && toggleSelect(w.id)}
                                        className={`flex justify-between items-start p-4 rounded-xl border transition-all ${
                                            isSelected 
                                                ? `ring-2 ring-offset-2 ring-offset-slate-50 dark:ring-offset-slate-900 ${theme.borderActive} ${darkMode ? 'bg-slate-800' : 'bg-white'}` 
                                                : `${darkMode ? 'bg-slate-800 border-slate-700' : `bg-white ${theme.border}`}`
                                        } ${isSelectionMode ? 'cursor-pointer hover:opacity-90' : ''}`}
                                    >
                                        <div className="flex items-center gap-3 flex-1">
                                            {isSelectionMode && (
                                                <div className={`text-2xl transition-colors ${isSelected ? theme.text : 'text-slate-300'}`}>
                                                    {isSelected ? <Icons.CheckSquare /> : <Icons.Square />}
                                                </div>
                                            )}
                                            <div>
                                                <div className={`text-xl font-bold serif-font ${darkMode ? theme.darkText : theme.text}`}>{w.text}</div>
                                                <div className="flex flex-wrap gap-2 mt-2">
                                                    <span className={`text-sm font-medium px-2 py-1 rounded-md ${darkMode ? 'bg-slate-700 text-slate-300' : `${theme.lightBg} text-slate-700`}`}>
                                                        {w.tr || "√áeviri yok"}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        {!isSelectionMode && (
                                            <button onClick={(e) => { e.stopPropagation(); deleteWord(w.id); }} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash /></button>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const Section = ({ text, isHeader, lang, theme, darkMode }) => {
            const [translated, setTranslated] = useState(null);
            const [loadingTr, setLoadingTr] = useState(false);

            const handleTranslate = async () => {
                if (translated) { setTranslated(null); return; }
                setLoadingTr(true);
                const result = await translateText(text, lang);
                setTranslated(result || "√áeviri yapƒ±lamadƒ±.");
                setLoadingTr(false);
            };

            if (isHeader) return <div className={`mt-8 mb-4 border-b ${darkMode ? 'border-slate-700' : 'border-slate-200'} pb-2`}><h3 className={`text-xl font-bold ${darkMode ? theme.darkText : theme.text}`} dangerouslySetInnerHTML={{__html: text}} /></div>;

            return (
                <div className="mb-6">
                    <div className={`text-lg leading-relaxed serif-font ${darkMode ? 'text-slate-300' : 'text-slate-800'}`} dangerouslySetInnerHTML={{ __html: text }} />
                    <button onClick={handleTranslate} className={`mt-2 inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wider transition-colors ${translated ? 'text-green-600' : `text-slate-400 hover:${theme.text}`}`}>
                        {loadingTr ? "..." : translated ? <><Icons.Check /> Gizle</> : <><Icons.Translate /> √áevir</>}
                    </button>
                    {translated && <div className={`mt-2 p-3 rounded-lg text-sm border-l-4 animate-fade-in ${darkMode ? 'bg-slate-800 border-green-600 text-slate-300' : `${theme.lightBg} border-slate-400 text-slate-700`}`}>{translated}</div>}
                </div>
            );
        };

        const App = () => {
            const [lang, setLang] = useState('en'); 
            const [tab, setTab] = useState('story');
            
            // Caches
            const [contentCache, setContentCache] = useState({ en: null, fr: null, it: null, de: null, es: null });
            const [wikiCache, setWikiCache] = useState({ en: null, fr: null, it: null, de: null, es: null });
            
            const [loading, setLoading] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [notifPerm, setNotifPerm] = useState("default");
            
            // Selection
            const [selectedText, setSelectedText] = useState("");
            const [translatedPreview, setTranslatedPreview] = useState(null); // Otomatik √ßeviri durumu
            const [isAddingWord, setIsAddingWord] = useState(false);
            const [toast, setToast] = useState(null);

            // Current Theme Styles
            const theme = THEMES[lang];

            // Dark Mode Sync
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // Selection Listener & Auto Translate Logic
            useEffect(() => {
                const handleSelection = async () => {
                    const selection = window.getSelection();
                    const text = selection?.toString().trim() || "";
                    
                    if (text.length > 1 && text.split(' ').length <= 4) {
                        if (text !== selectedText) {
                            setSelectedText(text);
                            setTranslatedPreview("..."); // Y√ºkleniyor i≈üareti
                            
                            // Otomatik √áevir
                            const tr = await translateText(text, lang);
                            setTranslatedPreview(tr || "?");
                        }
                    } else {
                        // Se√ßim yoksa veya √ßok uzunsa temizle
                        if (selectedText !== "") {
                            setSelectedText("");
                            setTranslatedPreview(null);
                        }
                    }
                };
                
                // Debounce yerine basit bir event listener kullanƒ±yoruz ancak react state update'leri yeterli olacaktƒ±r.
                // Daha iyi performans i√ßin mouseup tercih edilebilir.
                document.addEventListener('selectionchange', handleSelection);
                return () => document.removeEventListener('selectionchange', handleSelection);
            }, [lang, selectedText]);

            // Initial Fetch
            useEffect(() => {
                if (tab === 'story' && !contentCache[lang]) fetchContent('story');
                if (tab === 'wiki' && !wikiCache[lang]) fetchContent('wiki');
            }, [lang, tab]);

            const requestNotification = () => {
                if (!("Notification" in window)) {
                    showToast("Bu tarayƒ±cƒ± bildirimleri desteklemiyor.");
                    return;
                }

                Notification.requestPermission().then(perm => {
                    setNotifPerm(perm);
                    if(perm === 'granted') {
                        showToast("Bildirimler aktif! üîî");
                        try {
                            new Notification("Polyglot Reader", { body: "Bildirimler ba≈üarƒ±yla √ßalƒ±≈üƒ±yor!" });
                        } catch(e) {
                            console.log("Notification trigger failed (likely sandbox)");
                        }
                    } else {
                        showToast("Bildirim izni verilmedi.");
                    }
                });
            };

            const addSelectedWord = async (e) => {
                e.preventDefault(); e.stopPropagation();
                if (!selectedText || isAddingWord) return;
                setIsAddingWord(true);
                
                const word = selectedText;
                let meaning = translatedPreview;

                // Eƒüer √∂nizleme hala y√ºkleniyorsa veya yoksa tekrar dene
                if (!meaning || meaning === "...") {
                    try {
                        meaning = await translateText(word, lang);
                    } catch (err) { meaning = "?"; }
                }

                const newItem = { id: Date.now(), text: word, tr: meaning || "?", lang: lang };
                const saved = localStorage.getItem('polyglot_words');
                const current = saved ? JSON.parse(saved) : [];
                localStorage.setItem('polyglot_words', JSON.stringify([newItem, ...current]));
                
                window.dispatchEvent(new Event('wordsUpdated'));
                showToast(`"${word}" eklendi! (${lang.toUpperCase()})`);
                
                // Se√ßimi temizle
                window.getSelection().removeAllRanges();
                setSelectedText("");
                setTranslatedPreview(null);
                setIsAddingWord(false);
            };

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            // --- WIKI PARSER ---
            const parseWikiHTML = (html, title, domain, typeLabel) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const junk = doc.querySelectorAll('style, script, .mw-empty-elt, .reference, table, .infobox, .navbox, .metadata, .noprint');
                junk.forEach(el => el.remove());

                const sections = [];
                let idCounter = 0;

                const traverse = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent.trim();
                        if (text.length > 30) {
                            const parentTag = node.parentElement.tagName;
                            if(['P', 'DIV', 'LI', 'BLOCKQUOTE'].includes(parentTag)) {
                                if(sections.length > 0 && sections[sections.length-1].text === node.parentElement.innerHTML) return;
                                sections.push({ id: idCounter++, text: node.parentElement.innerHTML, isHeader: false });
                            }
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        if (['H1','H2','H3'].includes(node.tagName) && node.textContent.length > 3) {
                            sections.push({ id: idCounter++, text: node.innerHTML, isHeader: true });
                        } else {
                            node.childNodes.forEach(traverse);
                        }
                    }
                };
                traverse(doc.body);

                if (sections.length === 0) {
                    const raw = doc.body.innerText;
                    const parts = raw.split(/\n\n+/);
                    parts.forEach(p => { if (p.trim().length > 30) sections.push({id: idCounter++, text: p, isHeader: false}); });
                }
                
                if (sections.length === 0) throw new Error("ƒ∞√ßerik bo≈ü");

                return {
                    title: title,
                    sections: sections,
                    source: domain,
                    type: typeLabel,
                    url: `https://${domain}/wiki/${encodeURIComponent(title)}`,
                    image: null
                };
            };

            const fetchContent = async (reqTab) => {
                setLoading(true);
                setSelectedText("");
                const cfg = CONFIG[lang];
                const maxRetries = 3;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        let pageTitle = "";
                        let typeLabel = "";

                        if (reqTab === 'story') {
                            typeLabel = "Hikaye";
                            const shuffledCats = [...cfg.categories].sort(() => 0.5 - Math.random());
                            let items = [];
                            for (const cat of shuffledCats) {
                                try {
                                    const listRes = await fetch(`https://${cfg.wiki}/w/api.php?origin=*&action=query&list=categorymembers&cmtitle=${cat}&cmtype=page&cmlimit=100&format=json`);
                                    const listData = await listRes.json();
                                    if (listData.query && listData.query.categorymembers && listData.query.categorymembers.length > 0) {
                                        items = listData.query.categorymembers;
                                        break; 
                                    }
                                } catch (e) {
                                    console.warn(`Kategori y√ºklenemedi: ${cat}`, e);
                                }
                            }
                            if (!items || items.length === 0) throw new Error("T√ºm kategoriler bo≈ü veya eri≈üilemez.");
                            pageTitle = items[Math.floor(Math.random() * items.length)].title;
                        } else {
                            typeLabel = "Wiki";
                            const randomRes = await fetch(`https://${cfg.wiki}/w/api.php?origin=*&action=query&list=random&rnnamespace=0&rnlimit=1&format=json`);
                            const randomData = await randomRes.json();
                            pageTitle = randomData.query.random[0].title;
                        }

                        const contentUrl = `https://${cfg.wiki}/w/api.php?origin=*&action=parse&page=${encodeURIComponent(pageTitle)}&prop=text|images&mobileformat=1&format=json&disableeditsection=1&disabletoc=1`;
                        const imgUrl = `https://${cfg.wiki}/w/api.php?origin=*&action=query&titles=${encodeURIComponent(pageTitle)}&prop=pageimages&pithumbsize=600&format=json`;

                        const [contentRes, imgRes] = await Promise.all([fetch(contentUrl), fetch(imgUrl)]);
                        const contentData = await contentRes.json();
                        const imgData = await imgRes.json();

                        if (!contentData.parse) throw new Error("Parse Error");

                        const parsed = parseWikiHTML(contentData.parse.text['*'], contentData.parse.title, cfg.wiki, typeLabel);
                        
                        const pages = imgData.query.pages;
                        const pageId = Object.keys(pages)[0];
                        if (pages[pageId] && pages[pageId].thumbnail) parsed.image = pages[pageId].thumbnail.source;

                        // Success - set state and return
                        if (reqTab === 'story') setContentCache(prev => ({...prev, [lang]: parsed}));
                        else setWikiCache(prev => ({...prev, [lang]: parsed}));
                        
                        setLoading(false);
                        return;

                    } catch (error) {
                        console.warn(`Deneme ${i+1} ba≈üarƒ±sƒ±z:`, error.message);
                        if (i === maxRetries - 1) {
                            console.error("T√ºm denemeler ba≈üarƒ±sƒ±z.");
                            if (reqTab === 'story') {
                                setContentCache(prev => ({...prev, [lang]: cfg.backup}));
                                showToast("√áevrimdƒ±≈üƒ± yedek y√ºklendi (Hata).");
                            } else {
                                showToast("ƒ∞√ßerik y√ºklenemedi. Tekrar deneyin.");
                            }
                        }
                    }
                }
                setLoading(false);
            };

            const refreshCurrent = () => fetchContent(tab);
            const activeContent = tab === 'story' ? contentCache[lang] : wikiCache[lang];

            return (
                <div className={`min-h-screen transition-colors duration-500 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    
                    <header className={`sticky top-0 z-20 border-b backdrop-blur-md transition-colors duration-500 ${darkMode ? 'bg-slate-900/90 border-slate-700' : 'bg-white/90 border-slate-200'}`}>
                        <div className="max-w-3xl mx-auto px-4 py-3">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3 font-bold text-lg tracking-tight">
                                    <div className={`p-2 rounded-lg text-white flex items-center justify-center shadow-md transition-colors duration-500 ${theme.btnBg}`}>
                                        <Icons.Logo />
                                    </div>
                                    <span className="hidden sm:inline font-serif">Polyglot Reader</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={requestNotification} className={`p-2 rounded-full transition-colors ${notifPerm === 'granted' ? 'text-green-500 bg-green-500/10' : 'text-slate-400 hover:bg-black/5 dark:hover:bg-white/10'}`}>
                                        <Icons.Bell active={notifPerm === 'granted'} />
                                    </button>
                                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                                        {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                    </button>
                                </div>
                            </div>

                            <div className="flex overflow-x-auto no-scrollbar pb-1 mb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                                <div className={`flex p-1 rounded-xl border min-w-full sm:min-w-0 ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-100 border-slate-200'}`}>
                                    {Object.keys(CONFIG).map((l) => (
                                        <button 
                                            key={l}
                                            onClick={() => setLang(l)}
                                            className={`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2 whitespace-nowrap ${lang === l ? `bg-white shadow-sm dark:bg-slate-700 ${theme.text} dark:${theme.darkText}` : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                        >
                                            <span className="text-lg">{CONFIG[l].flag}</span>
                                            <span className="hidden md:inline">{CONFIG[l].name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-center gap-6 text-sm font-medium border-t pt-2 border-dashed border-slate-200 dark:border-slate-700">
                                <button onClick={() => setTab('story')} className={`pb-1 border-b-2 transition-colors flex items-center gap-1 ${tab === 'story' ? `${theme.borderActive} ${theme.text}` : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                    <Icons.BookOpen /> Hikaye
                                </button>
                                <button onClick={() => setTab('wiki')} className={`pb-1 border-b-2 transition-colors flex items-center gap-1 ${tab === 'wiki' ? `${theme.borderActive} ${theme.text}` : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                    Web
                                </button>
                                <button onClick={() => setTab('words')} className={`pb-1 border-b-2 transition-colors flex items-center gap-1 ${tab === 'words' ? `${theme.borderActive} ${theme.text}` : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                    <Icons.Archive /> Kelimeler
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto p-4 md:p-8 pb-32 relative min-h-[80vh]">
                        {tab === 'words' ? (
                            <WordBox currentLang={lang} theme={theme} darkMode={darkMode} />
                        ) : (
                            <>
                                {loading ? (
                                    <div className="flex flex-col items-center justify-center py-20 animate-pulse">
                                        <div className={`w-16 h-16 border-4 border-slate-200 border-t-transparent rounded-full animate-spin mb-4 border-t-${theme.text.split('-')[1]}-600`}></div>
                                        <p className="text-slate-400 font-medium">{CONFIG[lang].name} y√ºkleniyor...</p>
                                    </div>
                                ) : activeContent ? (
                                    <div className="animate-fade-in pb-20">
                                        <div className="mb-8 text-center">
                                            <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-3 ${darkMode ? 'bg-slate-800 text-slate-400' : `${theme.lightBg} ${theme.text}`}`}>{activeContent.type}</span>
                                            <h2 className="text-3xl md:text-5xl font-bold serif-font leading-tight mb-6">{activeContent.title}</h2>
                                            {activeContent.image && (
                                                <div className="relative w-full h-64 md:h-96 rounded-2xl overflow-hidden shadow-xl mb-8">
                                                    <img src={activeContent.image} className="w-full h-full object-cover" alt="Cover" />
                                                </div>
                                            )}
                                        </div>
                                        <div className={`article-content ${darkMode ? 'text-slate-300' : 'text-slate-800'}`}>
                                            {activeContent.sections.map((sec, idx) => (
                                                <Section key={idx} text={sec.text} isHeader={sec.isHeader} lang={lang} theme={theme} darkMode={darkMode} />
                                            ))}
                                        </div>
                                        <div className="mt-12 pt-8 border-t border-dashed border-slate-300 text-center text-sm text-slate-400">
                                            <p className="mb-2">Kaynak: {activeContent.source}</p>
                                            <a href={activeContent.url} target="_blank" className={`inline-flex items-center gap-1 ${theme.text} hover:underline`}>Orijinalini Oku</a>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-20">
                                        <p className="mb-4 text-slate-400">ƒ∞√ßerik y√ºklenemedi.</p>
                                        <button onClick={refreshCurrent} className={`${theme.btnBg} text-white px-6 py-2 rounded-full ${theme.btnHover} transition-colors`}>Yenile</button>
                                    </div>
                                )}
                            </>
                        )}

                        {selectedText && tab !== 'words' && (
                            <div className="fixed bottom-0 left-0 right-0 p-4 z-50 animate-slide-up flex justify-center">
                                <div className={`flex items-center gap-4 px-6 py-3 rounded-full shadow-2xl border ${darkMode ? 'bg-slate-800 border-slate-600' : `bg-white ${theme.border}`}`}>
                                    <div className="flex flex-col">
                                        <span className={`font-serif italic font-medium truncate max-w-[150px] ${darkMode ? 'text-slate-200' : 'text-slate-700'}`}>"{selectedText}"</span>
                                        <span className={`text-xs font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                            {translatedPreview === "..." ? <span className="animate-pulse">√áevriliyor...</span> : <span className="flex items-center gap-1"><Icons.ArrowRight/> {translatedPreview}</span>}
                                        </span>
                                    </div>
                                    <button
                                        onTouchStart={addSelectedWord}
                                        onClick={addSelectedWord}
                                        disabled={isAddingWord || !translatedPreview || translatedPreview === "..."}
                                        className={`${theme.btnBg} text-white px-5 py-2 rounded-full font-bold shadow-lg active:scale-95 transition-transform flex items-center gap-2 disabled:opacity-50`}
                                    >
                                        {isAddingWord ? <span className="animate-spin text-sm">‚è≥</span> : <Icons.Plus />}
                                        Ekle
                                    </button>
                                </div>
                            </div>
                        )}

                        {toast && (
                            <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-800/95 backdrop-blur-md text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-fade-in z-50">
                                <Icons.Check /> <span className="font-medium text-sm">{toast}</span>
                            </div>
                        )}
                    </main>

                    {tab !== 'words' && !selectedText && (
                        <div className="fixed bottom-8 right-6 z-30">
                            <button onClick={refreshCurrent} disabled={loading} className={`h-16 w-16 rounded-3xl shadow-2xl border-4 border-white dark:border-slate-800 flex items-center justify-center transition-all hover:scale-110 active:scale-95 ${loading ? 'bg-slate-400' : `${theme.btnBg} text-white`}`}>
                                <Icons.Magic loading={loading} />
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


